<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Ponto</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-xl bg-white rounded-2xl shadow-md p-6 mt-8">
    <h1 class="text-2xl font-bold text-center mb-6">Registro de Ponto</h1>

    <div id="loginArea" class="text-center mb-6">
      <button id="loginBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Login com Google</button>
    </div>

    <div id="appArea" class="space-y-4 hidden">
      <div>
        <label>Horário:</label>
        <select id="fieldSelect" class="w-full p-2 border rounded">
          <option value="startWork">Início do Expediente</option>
          <option value="startLunch">Início do Almoço</option>
          <option value="endLunch">Fim do Almoço</option>
          <option value="endWork">Fim do Expediente</option>
        </select>
      </div>

      <div>
        <input type="time" id="timeInput" class="w-full p-2 border rounded" />
      </div>

      <button id="saveBtn" class="w-full bg-blue-600 text-white rounded p-2 hover:bg-blue-700">Salvar Horário</button>

      <div id="mensagem" class="text-sm mt-2"></div>

      <hr class="my-4">

      <div>
        <p class="font-semibold mb-2">Horas Trabalhadas (esta semana):</p>
        <ul id="historico" class="text-sm space-y-1"></ul>
        <p class="mt-2 font-bold">Total semanal: <span id="totalSemana">0h</span></p>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwcTmY404LbkQh8mblRinCRs9Zx_MNe5sp5g0EX3VGdFePxULzTgyYzce2OSBMVjl5c/exec";

  let usuarioEmail = null;

  // Função para pegar token da URL e buscar info usuário
  function getAccessTokenFromUrl() {
    const hash = window.location.hash.substr(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  window.onload = () => {
    const token = getAccessTokenFromUrl();
    if (token) {
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        usuarioEmail = data.email;
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('appArea').classList.remove('hidden');
        carregarHoras();
      });
    }
  };

  document.getElementById('loginBtn').onclick = () => {
    const client_id = '901853598842-ht0imaf0f4e0k2qbtdnkov4pjegqnajr.apps.googleusercontent.com';
    const redirect_uri = window.location.origin + window.location.pathname;
    const scope = 'email profile openid';
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
    window.location.href = authUrl;
  };

  document.getElementById('saveBtn').onclick = async () => {
    const campo = document.getElementById('fieldSelect').value;
    const horario = document.getElementById('timeInput').value;
    if (!horario) {
      alert('Por favor, selecione um horário.');
      return;
    }

    const payload = { email: usuarioEmail, campo, horario };

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });

      const texto = await res.text();
      document.getElementById('mensagem').innerText = texto;
      document.getElementById('mensagem').style.color = 'green';

      carregarHoras();
    } catch(e) {
      document.getElementById('mensagem').innerText = 'Erro ao enviar horário.';
      document.getElementById('mensagem').style.color = 'red';
    }
  };

  async function carregarHoras() {
    if (!usuarioEmail) return;

    try {
      const res = await fetch(`${API_URL}?email=${encodeURIComponent(usuarioEmail)}`);
      const dados = await res.json();

      const lista = document.getElementById('historico');
      lista.innerHTML = '';
      let total = 0;

      dados.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.data}: ${item.total}h`;
        lista.appendChild(li);
        total += parseFloat(item.total);
      });

      document.getElementById('totalSemana').innerText = total.toFixed(2) + 'h';

    } catch (e) {
      console.error(e);
    }
  }
</script>
</body>
</html>
