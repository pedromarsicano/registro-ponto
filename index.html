
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Ponto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-xl bg-white rounded-2xl shadow-md p-6 mt-8">
    <h1 class="text-2xl font-bold text-center mb-6">Registro de Ponto</h1>

    <div id="loginArea" class="text-center mb-6">
      <div id="g_id_onload"
           data-client_id="901853598842-ht0imaf0f4e0k2qbtdnkov4pjegqnajr.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div id="appArea" class="space-y-4 hidden">
      <div>
        <label class="block font-semibold">Horário:</label>
        <select id="fieldSelect" class="w-full p-2 border rounded">
          <option value="startWork">Início do Expediente</option>
          <option value="startLunch">Início do Almoço</option>
          <option value="endLunch">Fim do Almoço</option>
          <option value="endWork">Fim do Expediente</option>
        </select>
      </div>

      <div>
        <input type="time" id="timeInput" class="w-full p-2 border rounded" />
      </div>

      <button onclick="salvarRegistro()" class="w-full bg-blue-600 text-white rounded p-2 hover:bg-blue-700">Salvar Horário</button>

      <div id="mensagem" class="text-sm text-green-600 mt-2"></div>

      <hr class="my-4">

      <div>
        <p class="font-semibold mb-2">Horas Trabalhadas (esta semana):</p>
        <ul id="historico" class="text-sm space-y-1"></ul>
        <p class="mt-2 font-bold">Total semanal: <span id="totalSemana">0h</span></p>
      </div>
    </div>
  </div>

  <script>
    let usuarioEmail = null;

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      usuarioEmail = data.email;
      document.getElementById('loginArea').classList.add('hidden');
      document.getElementById('appArea').classList.remove('hidden');
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    async function salvarRegistro() {
      const campo = document.getElementById("fieldSelect").value;
      const horario = document.getElementById("timeInput").value;
      const url = "https://script.google.com/macros/s/AKfycbwcTmY404LbkQh8mblRinCRs9Zx_MNe5sp5g0EX3VGdFePxULzTgyYzce2OSBMVjl5c/exec";

      const payload = {
        email: usuarioEmail,
        campo: campo,
        horario: horario
      };

      const res = await fetch(url, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      const msg = await res.text();
      document.getElementById("mensagem").innerText = msg;
      carregarHoras();
    }

    async function carregarHoras() {
      const url = "https://script.google.com/macros/s/AKfycbwcTmY404LbkQh8mblRinCRs9Zx_MNe5sp5g0EX3VGdFePxULzTgyYzce2OSBMVjl5c/exec?email=" + usuarioEmail;
      const res = await fetch(url);
      const dados = await res.json();

      const lista = document.getElementById("historico");
      lista.innerHTML = "";
      let total = 0;

      dados.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.data}: ${item.total}h`;
        lista.appendChild(li);
        total += parseFloat(item.total);
      });

      document.getElementById("totalSemana").innerText = total.toFixed(2) + "h";
    }
  </script>
</body>
</html>
